---
 - name: Install a DHCP & NAT Server on Debian/Ubuntu
   hosts: dhcpsrvrs
   vars:
     public_net: enp0s3
     private_net: enp0s8
     dhcp_server: 192.168.56.4
     dhcp_subnet: 192.168.56.0
     dhcp_netmask: 255.255.255.0
     dhcp_subnet_range: '192.168.56.10 192.168.56.200'
     dhcp_router1: 192.168.56.4
     domain_name: mieweb.local
     domain_name_server1: 8.8.8.8
     domain_name_server2: 8.8.4.4
   become: true

   tasks:
    # Install and configure a DHCP Server     
    - name: Update apt cache and upgrade all packages
      register: updatesys
      apt:
        name: "*"
        state: latest
        update_cache: yes

    - name: Install the isc-dhcp-server package
      apt:
        name: isc-dhcp-server
        state: present

    - name: Add the path to dhcpd's config file 
      replace:
        path: /etc/default/isc-dhcp-server
        regexp: '#DHCPDv4_CONF=/etc/dhcp/dhcpd.conf'
        replace: 'DHCPDv4_CONF=/etc/dhcp/dhcpd.conf'

    - name: Add the host-only network interface to the dhcpd's config file
      replace:
        path: /etc/default/isc-dhcp-server
        regexp: 'INTERFACESv4=""'
        replace: 'INTERFACESv4={{ private_net }}'

    - name: Modify the default domain name to the dhcp server's configuration
      replace:
        path: /etc/dhcp/dhcpd.conf
        regexp: 'option domain-name "example.org";'
        replace: 'option domain-name "{{ domain_name }}";'

    - name: Modify the default dns servers to the dhcp server's configuration
      replace: 
        path: /etc/dhcp/dhcpd.conf
        regexp: 'option domain-name-servers ns1.example.org, ns2.example.org;'
        replace: 'option domain-name-servers {{ domain_name_server1 }}, {{ domain_name_server2 }};'

    - name: Add a dhcp scope to the dhcp server's configuraiton
      blockinfile:
        path: /etc/dhcp/dhcpd.conf
        block: | 
          # DHCP Range
          subnet {{ dhcp_subnet }} netmask {{ dhcp_netmask }} {
            range {{ dhcp_subnet_range }};
            option routers {{ dhcp_router1 }};
          }
        insertbefore: '# The ddns-updates-style parameter controls whether or not the server will'

    - name: Start the isc-dhcp-server with systemd
      systemd:
        name: isc-dhcp-server
        state: restarted
        enabled: yes
    
    # Install and configure a NAT Server
    - name: Enable IPv4 packet forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: 1
        state: present
        sysctl_set: yes

    - name: Install ufw firewall package
      apt:
        name: ufw
        state: present

    - name: Modify /etc/default/ufw to accept ip forwarding
      replace: 
        path: /etc/default/ufw
        regexp: 'DEFAULT_FORWARD_POLICY="DROP"'
        replace: 'DEFAULT_FORWARD_POLICY="ACCEPT"'

    - name: Modify /etc/ufw/before.rules to include NAT rules
      blockinfile:
        path: /etc/ufw/before.rules
        block: |
          # NAT table rules
          *nat
          :POSTROUTING ACCEPT [0:0]
          -A POSTROUTING -s {{ dhcp_subnet }}/24 -o {{ public_net }} -j MASQUERADE
          COMMIT
        insertbefore: "^# Don't delete these required lines"

    - name: Restart ufw
      shell: ufw disable;echo "y" | sudo ufw enable;ufw allow 22/tcp
